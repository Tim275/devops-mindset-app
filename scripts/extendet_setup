#!/bin/bash
set -e

echo "🚀 Setting up development environment..."

# Git setup
git config --global push.autoSetupRemote true
git config --global --add safe.directory /workspaces/devops-projekt
git config --global user.name "${GIT_AUTHOR_NAME:-Tim275}"
git config --global user.email "${GIT_AUTHOR_EMAIL:-sagichdirnicht259@outlook.de}"

# Setup mise tools
mise trust
mise install

# WICHTIG: mise aktivieren für aktuelle Session
eval "$(mise activate bash)"

# Install Backend dependencies
echo "📦 Installing Backend dependencies..."
python -m pip install fastapi uvicorn pydantic

# Install Frontend dependencies
echo "📦 Installing Frontend dependencies..."
python -m pip install flask requests jinja2 pytest

# Install commitizen with proper PATH (CONDITIONAL!)
if ! command -v cz >/dev/null; then
    echo "🛠️ Installing commitizen..."
    python -m pip install --user pipx
    export PATH="/home/vscode/.local/bin:$PATH"
    echo 'export PATH="/home/vscode/.local/bin:$PATH"' >> ~/.bashrc
    pipx install commitizen
    echo "✅ commitizen installed"
fi

echo ""
echo "✅ Setup complete!"
echo "Tools:"
command -v python && echo "✅ python: $(python --version)" || echo "❌ python"
command -v cz && echo "✅ commitizen" || echo "❌ commitizen"
echo ""
echo "🎯 Ready for development!"
echo "💡 Backend: ./scripts/start_backend (Port 22112)"
echo "💡 Frontend: ./scripts/start_frontend (Port 22111)"
echo "💡 Tests: ./scripts/run_tests"
echo "💡 Note: Run 'eval \"\$(mise activate bash)\"' in new shells"